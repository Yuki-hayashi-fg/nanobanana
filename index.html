<!DOCTYPE html>
<html class="dark" lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Nano Banana Pro Studio</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#7f13ec",
                        "primary-dark": "#620eb5",
                        "background-light": "#f7f6f8",
                        "background-dark": "#0f0e13",
                        "surface-dark": "#1e1b24",
                        "input-dark": "#2d2836",
                        "border-dark": "#3c334a",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "Noto Sans JP", "sans-serif"],
                        "body": ["Noto Sans JP", "sans-serif"],
                        "mono": ["ui-monospace", "SFMono-Regular", "Menlo", "Monaco", "monospace"],
                    },
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f0e13; }
        ::-webkit-scrollbar-thumb { background: #3c334a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7f13ec; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #toast-container { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; pointer-events: none; }
        .toast { min-width: 260px; max-width: 360px; background: linear-gradient(135deg, rgba(127, 19, 236, 0.12), rgba(20, 18, 24, 0.95)); color: #f7f6f8; padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 10px 30px rgba(0,0,0,0.35); font-size: 14px; font-weight: 600; letter-spacing: 0.01em; backdrop-filter: blur(6px); transform: translateY(-6px); opacity: 0; animation: toastIn 200ms ease-out forwards; pointer-events: auto; }
        .toast.toast-error { border-color: rgba(248, 113, 113, 0.5); background: linear-gradient(135deg, rgba(248, 113, 113, 0.14), rgba(20, 18, 24, 0.95)); color: #fecdd3; }
        .toast-hide { opacity: 0; transform: translateY(-10px); transition: opacity 200ms ease, transform 200ms ease; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-8px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        #message-banner { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); z-index: 9998; pointer-events: none; }
    </style>
</head>
<body class="bg-background-dark text-white font-body h-screen flex overflow-hidden selection:bg-primary selection:text-white">

<div id="toast-container" aria-live="polite" aria-atomic="true"></div>
<div id="message-banner" class="hidden px-4 py-2 rounded-lg border text-sm font-semibold bg-white/10 border-white/20 shadow-lg shadow-black/30"></div>

<div id="auth-screen" class="flex flex-1 items-center justify-center w-full px-4">
    <div class="w-full max-w-md bg-surface-dark border border-border-dark rounded-2xl p-8 shadow-2xl space-y-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs text-[#ab9db9] uppercase font-bold tracking-widest">Nano Banana</p>
                <h2 id="auth-title" class="text-2xl font-display font-bold text-white mt-1">ログイン</h2>
            </div>
            <button id="auth-toggle" type="button" class="text-sm text-primary hover:text-white transition-colors font-bold">
                新規登録に切り替え
            </button>
        </div>
        <form id="auth-form" class="space-y-4">
            <div>
                <label for="email-input" class="block text-sm text-[#ab9db9] mb-1">メールアドレス</label>
                <input id="email-input" name="email" type="email" required placeholder="you@example.com" class="w-full bg-input-dark border border-border-dark rounded-lg px-3 py-3 text-sm focus:ring-1 focus:ring-primary focus:border-primary outline-none placeholder-gray-500" />
            </div>
            <div>
                <label for="password-input" class="block text-sm text-[#ab9db9] mb-1">パスワード</label>
                <input id="password-input" name="password" type="password" required minlength="6" placeholder="••••••••" class="w-full bg-input-dark border border-border-dark rounded-lg px-3 py-3 text-sm focus:ring-1 focus:ring-primary focus:border-primary outline-none placeholder-gray-500" />
            </div>
            <div id="password-confirm-container" class="hidden">
                <label for="password-confirm-input" class="block text-sm text-[#ab9db9] mb-1">パスワード（確認用）</label>
                <input id="password-confirm-input" name="password-confirm" type="password" minlength="6" placeholder="••••••••" class="w-full bg-input-dark border border-border-dark rounded-lg px-3 py-3 text-sm focus:ring-1 focus:ring-primary focus:border-primary outline-none placeholder-gray-500" />
            </div>
            <button id="auth-submit" type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 rounded-lg shadow-lg shadow-primary/20 transition-all active:scale-95">
                ログイン
            </button>
        </form>
        <div class="text-xs text-[#ab9db9]">
            Supabase 認証を利用してメールアドレスとパスワードでログイン／新規登録できます。
        </div>
        <div id="auth-error" class="text-sm text-red-400 bg-red-400/10 border border-red-400/30 rounded-lg px-3 py-2 hidden"></div>
    </div>
</div>

<div id="app-shell" class="flex flex-1 w-full hidden">

<aside class="w-72 border-r border-border-dark flex flex-col bg-[#141218] z-20 flex-shrink-0 hidden md:flex">
    <div class="p-5 border-b border-border-dark flex justify-between items-center">
        <h1 class="text-xl font-display font-bold flex items-center gap-2 cursor-pointer" onclick="switchView('dashboard')">
            <span class="material-symbols-outlined text-primary">auto_awesome</span>
            Nano Banana
        </h1>
    </div>

    <div class="flex-1 overflow-y-auto p-4 space-y-6">
        <div class="space-y-4 bg-surface-dark p-4 rounded-xl border border-border-dark">
            <h3 class="text-xs font-bold text-[#ab9db9] uppercase tracking-wider flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">tune</span> 設定
            </h3>
            
            <div>
                <label class="block text-xs text-[#ab9db9] mb-1">Model</label>
                <div class="relative">
                    <select id="model-select" onchange="changeModel()" class="w-full bg-input-dark border border-border-dark rounded-lg pl-3 pr-8 py-2 text-sm text-white focus:ring-1 focus:ring-primary focus:border-primary outline-none appearance-none cursor-pointer hover:border-primary/50">
                        </select>
                    <span class="material-symbols-outlined absolute right-2 top-2.5 text-[#ab9db9] pointer-events-none text-sm">expand_more</span>
                </div>
                <div class="mt-2 p-2 bg-black/20 rounded border border-white/5 flex justify-between items-center">
                    <span class="text-[10px] text-[#ab9db9] truncate max-w-[120px]" id="model-id-display">gemini-3-pro</span>
                    <span class="text-[10px] font-mono text-green-400 bg-green-400/10 px-1.5 py-0.5 rounded" id="model-cost-display">$0.134</span>
                </div>
            </div>

        </div>

        <div class="space-y-2 bg-surface-dark p-4 rounded-xl border border-border-dark">
            <h3 class="text-xs font-bold text-[#ab9db9] uppercase tracking-wider flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">history</span> ライブラリ
            </h3>
            <button onclick="openHistory()" class="w-full flex items-center justify-between px-3 py-2 rounded-lg border border-border-dark bg-black/20 hover:bg-white/5 transition-colors text-sm font-medium">
                <span class="flex items-center gap-2 text-gray-100">
                    <span class="material-symbols-outlined text-base">photo_library</span> 画像履歴
                </span>
                <span class="material-symbols-outlined text-sm text-[#ab9db9]">chevron_right</span>
            </button>
        </div>

        <div class="space-y-3">
            <div class="flex items-center justify-between px-1">
                <h3 class="text-xs font-bold text-[#ab9db9] uppercase tracking-wider">テンプレート</h3>
                <button onclick="openEditor()" class="text-[#ab9db9] hover:text-white transition-colors" title="新規作成">
                    <span class="material-symbols-outlined text-sm">add</span>
                </button>
            </div>
            <div id="template-list" class="flex flex-col gap-2">
                </div>
        </div>
    </div>
</aside>

<main class="flex-1 relative h-full overflow-hidden">

    <div class="absolute top-4 right-4 z-50 flex items-center gap-2">
        <span id="logged-in-user" class="hidden text-sm text-[#ab9db9] bg-black/30 px-3 py-1.5 rounded-full border border-border-dark"></span>
        <button id="logout-button" class="px-3 py-2 rounded-lg border border-border-dark bg-surface-dark text-sm text-white hover:bg-white/5 transition-colors hidden">
            ログアウト
        </button>
    </div>

    <div id="view-dashboard" class="flex flex-col h-full absolute inset-0 transition-transform duration-300">
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 sm:p-8 space-y-8 scroll-smooth pb-10">
            <div class="flex flex-col items-center justify-center py-20 opacity-40 select-none">
                <div class="size-20 bg-primary/20 rounded-full flex items-center justify-center mb-6 animate-pulse">
                    <span class="material-symbols-outlined text-4xl text-primary">auto_awesome</span>
                </div>
                <h2 class="text-2xl font-display font-bold text-white mb-2">Ready to Create</h2>
                <p class="text-[#ab9db9] text-sm font-mono bg-white/5 px-3 py-1 rounded-full">Select a model to start</p>
            </div>
        </div>
        <div class="flex-shrink-0 bg-[#141218] border-t border-border-dark p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] z-30">
            <div class="max-w-4xl mx-auto flex flex-col gap-5">
                
                <div class="flex justify-center -mt-10 mb-0 pointer-events-none">
                    <div class="inline-flex bg-[#141218] p-1 rounded-xl shadow-lg border border-border-dark pointer-events-auto">
                        <button id="mode-free" onclick="setGenMode('free')" class="px-4 py-2 rounded-lg bg-primary text-white shadow-sm text-sm font-bold transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">edit_note</span> Free
                        </button>
                        <button id="mode-template" onclick="setGenMode('template')" class="px-4 py-2 rounded-lg text-[#ab9db9] hover:text-white hover:bg-white/5 text-sm font-medium transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">grid_view</span> Template
                        </button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4 items-start">
                    <div class="flex-1 w-full">
                        <div id="input-free" class="relative group">
                            <textarea id="prompt-input" class="w-full bg-surface-dark border border-border-dark rounded-xl p-4 text-white placeholder-[#5a4f69] focus:border-primary focus:ring-1 focus:ring-primary outline-none resize-none h-32 transition-all font-body leading-relaxed" placeholder="どのような画像を生成しますか？..."></textarea>
                            <div class="mt-3 space-y-2">
                                <div class="flex items-center gap-2 text-xs text-[#ab9db9] font-semibold uppercase">
                                    <span class="material-symbols-outlined text-sm">bookmark</span>
                                    <span>テンプレートを挿入</span>
                                </div>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <div class="relative flex-1">
                                        <select id="prompt-template-select" class="w-full bg-input-dark border border-border-dark rounded-lg pl-3 pr-8 py-2 text-sm text-white focus:ring-1 focus:ring-primary focus:border-primary outline-none appearance-none cursor-pointer">
                                            <option value="">テンプレートを選択...</option>
                                        </select>
                                        <span class="material-symbols-outlined absolute right-2 top-2.5 text-[#ab9db9] pointer-events-none text-sm">expand_more</span>
                                    </div>
                                    <button id="prompt-template-apply" class="px-3 py-2 rounded-lg border border-border-dark bg-black/30 text-xs font-bold text-white hover:bg-white/10 transition-colors whitespace-nowrap">
                                        挿入する
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3 space-y-2">
                                <div class="flex items-center gap-2 text-xs text-[#ab9db9] font-semibold uppercase">
                                    <span class="material-symbols-outlined text-sm">palette</span>
                                    <span>スタイル参照画像 (任意)</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <label for="style-image-input" class="inline-flex items-center gap-2 px-3 py-2 border border-border-dark rounded-lg bg-black/30 text-xs text-white cursor-pointer hover:border-primary/70 hover:bg-white/5 transition-colors">
                                        <span class="material-symbols-outlined text-base">upload</span>
                                        <span>画像を選択</span>
                                    </label>
                                    <input type="file" id="style-image-input" accept="image/*" class="hidden" />
                                    <div id="style-image-preview" class="hidden flex items-center gap-2 text-xs text-[#ab9db9]">
                                        <img id="style-image-preview-img" alt="Style preview" class="w-14 h-14 object-cover rounded-lg border border-border-dark bg-black/30" />
                                        <button type="button" id="style-image-clear" class="text-[11px] px-2 py-1 rounded-md border border-border-dark bg-white/5 hover:bg-white/10 text-white transition-colors">クリア</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="input-template" class="hidden flex flex-col gap-2 h-32">
                            <div id="selected-template-pill" class="hidden items-center gap-2 text-sm text-primary bg-primary/10 border border-primary/40 rounded-lg px-3 py-2">
                                <span class="material-symbols-outlined text-base">check_circle</span>
                                <span class="truncate">テンプレート「<span id="selected-template-name" class="font-semibold"></span>」を適用中</span>
                            </div>
                            <div id="template-form-container" class="grid grid-cols-2 gap-3 bg-surface-dark border border-border-dark rounded-xl p-4 h-full overflow-y-auto">
                                <div class="col-span-2 text-center text-[#ab9db9] text-sm flex flex-col items-center justify-center h-full">
                                    サイドバーからテンプレートを選択してください
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-row md:flex-col gap-3 w-full md:w-56">
                        
                        <div class="bg-surface-dark rounded-xl border border-border-dark p-3 flex flex-col gap-3">
                            
                            <div>
                                <label class="text-[10px] font-bold text-[#ab9db9] uppercase mb-1 block">比率</label>
                                <div class="relative z-10">
                                    <input id="gen-aspect-ratio" list="aspect-ratio-options" inputmode="text" placeholder="例: 7:5" class="w-full bg-[#150d1c] border border-border-dark rounded-lg pl-3 pr-8 py-2 text-sm text-white focus:ring-1 focus:ring-primary focus:border-primary outline-none transition-colors hover:border-primary/50" value="1:1" />
                                    <datalist id="aspect-ratio-options">
                                        <option value="1:1"></option>
                                        <option value="9:16"></option>
                                        <option value="16:9"></option>
                                        <option value="3:4"></option>
                                        <option value="4:3"></option>
                                        <option value="3:2"></option>
                                        <option value="2:3"></option>
                                        <option value="5:4"></option>
                                        <option value="4:5"></option>
                                        <option value="21:9"></option>
                                    </datalist>
                                    <span class="material-symbols-outlined absolute right-2 top-2 text-[#ab9db9] pointer-events-none text-sm z-0">unfold_more</span>
                                </div>
                            </div>

                            <div>
                                <label class="text-[10px] font-bold text-[#ab9db9] uppercase mb-1 block">解像度</label>
                                <div class="relative">
                                    <select id="gen-resolution" class="w-full bg-[#150d1c] border border-border-dark rounded-lg pl-3 pr-8 py-2 text-sm text-white focus:ring-1 focus:ring-primary focus:border-primary outline-none appearance-none cursor-pointer transition-colors hover:border-primary/50">
                                        <option value="1K">1K</option>
                                        <option value="2K">2K</option>
                                        <option value="4K">4K</option>
                                    </select>
                                    <span class="material-symbols-outlined absolute right-2 top-2 text-[#ab9db9] pointer-events-none text-sm">unfold_more</span>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="text-[10px] font-bold text-[#ab9db9] uppercase">生成枚数</label>
                                    <span id="gen-count-display" class="text-xs font-mono bg-white/10 px-1.5 rounded text-white">1</span>
                                </div>
                                <input type="range" id="gen-count" min="1" max="4" value="1" class="w-full h-1.5 bg-border-dark rounded-lg appearance-none cursor-pointer accent-primary" oninput="document.getElementById('gen-count-display').innerText = this.value">
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="text-[10px] font-bold text-[#ab9db9] uppercase">Temperature</label>
                                    <span id="gen-temperature-display" class="text-xs font-mono bg-white/10 px-1.5 rounded text-white">0.7</span>
                                </div>
                                <input type="range" id="gen-temperature" min="0" max="1" step="0.05" value="0.7" class="w-full h-1.5 bg-border-dark rounded-lg appearance-none cursor-pointer accent-primary">
                            </div>

                        </div>

                        <button id="generate-btn" class="flex-1 py-3 bg-primary hover:bg-primary-dark text-white rounded-xl font-bold shadow-lg shadow-primary/20 hover:shadow-primary/40 transition-all active:scale-95 flex items-center justify-center gap-2 whitespace-nowrap min-h-[50px]">
                            <span class="material-symbols-outlined text-2xl">auto_awesome</span>
                            <span class="md:hidden lg:inline">Generate</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-editor" class="absolute inset-0 bg-background-dark flex flex-col z-40 transform translate-x-full transition-transform duration-300 overflow-y-auto">
        <header class="flex items-center justify-between border-b border-border-dark px-6 py-4 bg-background-dark/80 backdrop-blur-md sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <button onclick="switchView('dashboard')" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-surface-dark transition-colors group">
                    <span class="material-symbols-outlined text-gray-400 group-hover:text-primary">arrow_back</span>
                </button>
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-primary/10 rounded-lg hidden sm:block">
                        <span class="material-symbols-outlined text-primary">edit_document</span>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight text-white" id="editor-title">テンプレート作成</h1>
                </div>
            </div>
            <button onclick="switchView('dashboard')" class="px-5 py-2.5 text-sm font-medium text-gray-300 hover:bg-surface-dark rounded-lg transition-colors border border-transparent">
                キャンセル
            </button>
        </header>

        <div class="flex-1 p-4 md:p-8 flex justify-center w-full">
            <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
                <div class="lg:col-span-8 flex flex-col gap-4">
                    <div class="flex flex-col flex-1 bg-surface-dark rounded-2xl border border-border-dark p-1 shadow-sm overflow-hidden min-h-[500px]">
                        <div class="flex items-center justify-between px-5 py-3 border-b border-border-dark bg-[#150d1c]/50">
                            <label class="text-sm font-bold uppercase tracking-wider text-gray-400 flex items-center gap-2">
                                <span class="material-symbols-outlined text-lg">terminal</span> Prompt Editor
                            </label>
                            <div class="flex items-center gap-3">
                                <button onclick="insertVariable()" class="flex items-center gap-1.5 px-3 py-1.5 bg-surface-dark hover:bg-[#2a2430] border border-gray-700 rounded-md text-xs font-semibold text-gray-200 transition-all shadow-sm active:scale-95 group">
                                    <span class="material-symbols-outlined text-[16px] text-primary">data_object</span>
                                    変数挿入 {{ }}
                                </button>
                                <div class="h-4 w-px bg-gray-700"></div>
                                <span class="text-xs font-medium text-gray-500 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[14px]">code</span> Markdown OK
                                </span>
                            </div>
                        </div>
                        <div class="relative flex-1 group bg-[#150d1c]">
                            <textarea id="editor-prompt" class="w-full h-full border-0 bg-transparent p-6 text-base md:text-lg leading-relaxed focus:ring-0 resize-none font-mono text-gray-100 placeholder-gray-600" placeholder="ここに画像生成のプロンプトを入力してください...&#10;例: A futuristic city at {{time}}, cyberpunk style, neon lights, {{weather}}, highly detailed 8k." spellcheck="false"></textarea>
                        </div>
                        <div class="bg-[#1a1421] px-5 py-3 border-t border-border-dark">
                            <div class="flex items-start gap-3">
                                <span class="material-symbols-outlined text-primary text-sm mt-0.5">info</span>
                                <p class="text-sm text-gray-400">
                                    <span class="font-bold font-mono text-primary bg-primary/10 px-1 rounded">{{キーワード}}</span> を使用して、ユーザーが入力できる変数を定義します。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-4 flex flex-col gap-6">
                    <div class="bg-surface-dark rounded-2xl border border-border-dark p-6 shadow-sm">
                        <label class="flex items-center gap-2 text-sm font-bold text-gray-200 mb-3">
                            <span class="material-symbols-outlined text-lg">label</span> テンプレート名
                        </label>
                        <div class="relative">
                            <input id="editor-name" class="w-full bg-[#150d1c] border border-border-dark rounded-xl px-4 py-3.5 pl-11 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-white placeholder-gray-600 font-medium" placeholder="名前を入力..." type="text"/>
                            <span class="material-symbols-outlined absolute left-3.5 top-3.5 text-gray-500">edit</span>
                        </div>
                        <input type="hidden" id="editor-id" value="">
                    </div>

                    <div class="bg-surface-dark rounded-2xl border border-border-dark p-6 shadow-sm">
                        <label class="flex items-center gap-2 text-sm font-bold text-gray-200 mb-3">
                            <span class="material-symbols-outlined text-lg">aspect_ratio</span> デフォルト比率
                        </label>
                        <div class="relative">
                            <input id="editor-aspect-ratio" list="aspect-ratio-options" inputmode="text" placeholder="例: 7:5" class="w-full bg-[#150d1c] border border-border-dark rounded-xl px-4 py-3.5 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-white font-medium" value="1:1" />
                            <span class="material-symbols-outlined absolute right-4 top-4 text-gray-500 pointer-events-none">expand_more</span>
                        </div>
                    </div>

                    <div class="flex-1"></div>
                    <div class="sticky bottom-4 z-10">
                        <button id="save-template-button" onclick="saveTemplate()" class="w-full bg-primary hover:bg-[#6b0fca] text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-primary/30 flex items-center justify-center gap-3 transition-all transform active:scale-[0.98] group">
                            <span class="material-symbols-outlined group-hover:animate-bounce">save</span>
                            <span class="tracking-wide">テンプレートを保存</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-history" class="absolute inset-0 bg-background-dark flex flex-col z-40 transform translate-x-full transition-transform duration-300 overflow-y-auto">
        <header class="flex items-center justify-between border-b border-border-dark px-6 py-4 bg-background-dark/80 backdrop-blur-md sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <button onclick="switchView('dashboard')" class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-surface-dark transition-colors group">
                    <span class="material-symbols-outlined text-gray-400 group-hover:text-primary">arrow_back</span>
                </button>
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-primary/10 rounded-lg hidden sm:block">
                        <span class="material-symbols-outlined text-primary">photo_library</span>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight text-white">生成履歴</h1>
                </div>
            </div>
            <div class="text-[11px] text-[#ab9db9] bg-white/5 px-3 py-1.5 rounded-full border border-border-dark">最新の生成結果を保存しています</div>
        </header>

        <div class="flex-1 p-4 md:p-8 flex justify-center w-full">
            <div class="w-full max-w-6xl space-y-4">
                <div class="flex items-center justify-between">
                    <div class="text-xs uppercase text-[#ab9db9] font-bold tracking-wider flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">collections</span> ライブラリ
                    </div>
                    <div class="text-[11px] text-[#ab9db9] bg-white/5 px-2 py-1 rounded-full border border-white/10">最大500件の履歴を表示</div>
                </div>

                <div id="history-section" class="bg-surface-dark border border-border-dark rounded-2xl p-6 hidden shadow-lg shadow-black/20">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-xs font-bold text-[#ab9db9] uppercase tracking-wider">生成履歴</p>
                            <h3 class="text-lg font-display font-bold text-white">最近の画像</h3>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4">
                        <div class="text-sm text-[#ab9db9]">プロンプトで履歴を絞り込めます。</div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <input id="history-search-input" type="text" placeholder="プロンプトを検索..." class="flex-1 sm:w-64 bg-input-dark border border-border-dark rounded-lg px-3 py-2 text-sm text-white focus:ring-1 focus:ring-primary focus:border-primary outline-none placeholder-gray-500" />
                            <button id="history-search-btn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-primary-dark transition-colors border border-primary/50">検索</button>
                        </div>
                    </div>
                    <div id="history-empty" class="text-sm text-[#ab9db9] bg-black/30 border border-border-dark rounded-xl p-4 text-center">生成履歴はまだありません。画像を生成するとここに保存されます。</div>
                    <div id="history-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                    <div class="flex justify-center mt-4">
                        <button id="history-load-more" class="hidden px-5 py-2 text-sm font-bold rounded-lg border border-border-dark bg-black/30 hover:bg-white/5 transition-colors">もっと見る</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>

</div>

<div id="settings-fab" class="fixed bottom-4 left-4 z-40 hidden">
    <button onclick="openSettingsPanel()" class="flex items-center gap-2 bg-primary text-white px-4 py-3 rounded-full shadow-xl shadow-primary/30 hover:bg-primary-dark transition-all">
        <span class="material-symbols-outlined">settings</span>
        <span class="text-sm font-bold">設定</span>
    </button>
</div>

<div id="settings-modal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-end md:items-center justify-start p-4">
    <div class="bg-surface-dark border border-border-dark rounded-2xl shadow-2xl w-full max-w-md p-6 space-y-4 fade-in">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs uppercase text-[#ab9db9] font-bold tracking-wider">Environment</p>
                <h3 class="text-lg font-display font-bold">設定</h3>
            </div>
            <button onclick="closeSettingsPanel()" class="text-[#ab9db9] hover:text-white transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="space-y-2">
            <label class="block text-xs text-[#ab9db9]">API Key</label>
            <input id="settings-api-key-input" type="password" placeholder="Google API Key..." class="w-full bg-input-dark border border-border-dark rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-primary focus:border-primary outline-none placeholder-gray-600" />
        </div>

        <div class="flex items-center justify-between gap-3">
            <div id="settings-save-status" class="text-xs text-green-400 opacity-0 transition-opacity">APIキーを保存しました。</div>
            <button onclick="saveApiKeyFromSettings()" class="bg-primary hover:bg-primary-dark text-white font-bold px-4 py-2 rounded-lg shadow-lg shadow-primary/30 transition-all active:scale-95 flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">save</span>
                保存
            </button>
        </div>
    </div>
</div>

<div id="image-modal" class="fixed inset-0 z-50 bg-black/95 hidden backdrop-blur-md flex items-center justify-center p-4">
    <button onclick="closeModal()" class="absolute top-4 right-4 text-white hover:text-primary transition-colors z-50 p-2">
        <span class="material-symbols-outlined text-3xl">close</span>
    </button>
    <div class="flex flex-col gap-4 max-h-screen w-full max-w-5xl">
        <div class="relative flex-1 rounded-xl overflow-hidden flex items-center justify-center group bg-black/40">
            <img id="modal-image" src="" class="max-h-[75vh] w-auto object-contain shadow-2xl rounded-lg">
            <div class="absolute bottom-4 right-4 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button id="modal-upscale-btn" onclick="event.stopPropagation(); regenerate4kFromModal();" class="upscale-btn px-4 py-2 rounded-full border border-white/15 bg-white/15 hover:bg-primary text-white text-sm font-bold shadow-lg shadow-black/30 disabled:opacity-60 disabled:cursor-not-allowed" data-image-url="">
                    4Kにする
                </button>
                <a id="modal-download" href="#" download="generated.png" class="bg-white/20 hover:bg-primary text-white p-3 rounded-full backdrop-blur-xl transition-all border border-white/10">
                    <span class="material-symbols-outlined">download</span>
                </a>
            </div>
        </div>
        <div id="modal-prompt-container" class="bg-surface-dark border border-border-dark rounded-xl p-4 space-y-2 shadow-lg shadow-black/40 hidden">
            <div class="text-xs font-bold text-[#ab9db9] uppercase tracking-wider flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">chat</span> 生成プロンプト
            </div>
            <p id="modal-prompt" class="text-sm text-white leading-relaxed whitespace-pre-wrap"></p>
            <div id="modal-reference-container" class="space-y-2 hidden">
                <div class="text-xs font-bold text-[#ab9db9] uppercase tracking-wider flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">image</span> 参照した画像
                </div>
                <img id="modal-reference-image" alt="Style reference" class="w-24 h-24 object-cover rounded-lg border border-border-dark bg-black/40" />
            </div>
        </div>
    </div>
</div>

<div id="delete-confirm-modal" class="fixed inset-0 z-50 bg-black/70 hidden backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-surface-dark border border-border-dark rounded-2xl shadow-2xl w-full max-w-md p-6 space-y-4 fade-in">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs uppercase text-[#ab9db9] font-bold tracking-wider">Confirm</p>
                <h3 class="text-lg font-display font-bold">削除の確認</h3>
            </div>
            <button onclick="closeDeleteModal()" class="text-[#ab9db9] hover:text-white transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <p class="text-sm text-gray-200">テンプレート「<span id="delete-template-name" class="font-bold text-white"></span>」を削除しますか？</p>

        <div class="flex items-center justify-end gap-3">
            <button onclick="closeDeleteModal()" class="px-4 py-2 rounded-lg border border-border-dark text-sm text-[#ab9db9] hover:text-white hover:bg-white/5 transition-colors">いいえ</button>
            <button onclick="confirmDeleteTemplate()" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-400 text-white font-bold shadow-lg shadow-red-500/30 transition-all">はい</button>
        </div>
    </div>
</div>

<script>
    // --- Storage Helpers ---
    class MemoryStorage {
        constructor() {
            this.store = {};
        }

        getItem(key) {
            return Object.prototype.hasOwnProperty.call(this.store, key) ? this.store[key] : null;
        }

        setItem(key, value) {
            this.store[key] = value;
        }

        removeItem(key) {
            delete this.store[key];
        }
    }

    const memoryStorage = new MemoryStorage();

    const safeStorage = memoryStorage;

    // --- Supabase Auth (Dummy Email) ---
    const SUPABASE_URL = 'https://zzpgthmjnatjxbomtnar.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_GD30ke1zlBkHOAZcZ2Nccw_LWZjGXCj';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
            storage: safeStorage,
            persistSession: false,
            autoRefreshToken: false,
            detectSessionInUrl: false,
        }
    });
    const SECRET_PHRASE = 'my-secret-phrase';
    let isSignupMode = false;
    let currentUserId = null;
    let currentApiKeyRecordId = null;

    // --- Model Configuration (Restored from working code) ---
    const MODELS = {
        "gemini-3-pro-image-preview": {
            name: "Nano Banana Pro",
            id: "gemini-3-pro-image-preview",
            type: "gemini", // generateContent
            cost: 0.134,
            desc: "New"
        },
        "imagen-3.0-generate-001": {
            name: "Imagen 3",
            id: "imagen-3.0-generate-001",
            type: "imagen", // predict
            endpointBase: "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict",
            cost: 0.036,
            desc: "Legacy"
        }
    };

    const ALLOWED_ASPECT_RATIOS = ['1:1', '2:3', '3:2', '3:4', '4:3', '4:5', '5:4', '9:16', '16:9', '21:9'];
    const ALLOWED_ASPECT_VALUES = ALLOWED_ASPECT_RATIOS.map(ratio => {
        const [w, h] = ratio.split(':').map(Number);
        return { ratio, value: w / h };
    });
    const ALLOWED_RESOLUTIONS = ['1K', '2K', '4K'];

    // --- State ---
    let templates = [];
    const DEFAULT_TEMPLATES = [];

    let activeModelKey = "gemini-3-pro-image-preview";
    let currentGenMode = 'free';
    let selectedTemplateId = null;
    let pendingDeleteTemplateId = null;
    let imageHistory = [];
    let currentSearchQuery = "";
    let historyLoadedCount = 0;
    let historyHasMore = false;
    let historyLoading = false;
    const HISTORY_PAGE_SIZE = 20;
    const imageMeta = new Map();
    let styleReferenceImage = null;

    // --- Settings Helpers ---
    function encryptApiKey(value) {
        return CryptoJS.AES.encrypt(value, SECRET_PHRASE).toString();
    }

    function decryptApiKey(encrypted) {
        try {
            const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_PHRASE);
            return bytes.toString(CryptoJS.enc.Utf8) || '';
        } catch (error) {
            console.warn('APIキーの復号に失敗しました', error);
            return '';
        }
    }

    function setApiKeyInputs(value) {
        const settingsInput = document.getElementById('settings-api-key-input');
        if (settingsInput) settingsInput.value = value || '';
    }

    // --- Toast Notifications ---
    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = `toast ${isError ? 'toast-error' : ''}`;
        toast.textContent = message;

        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('toast-hide');
        }, 2500);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    let bannerTimeout;
    function showBanner(message, isError = false) {
        const banner = document.getElementById('message-banner');
        if (!banner) return;

        banner.textContent = message;
        banner.classList.remove('hidden', 'text-red-300', 'border-red-400/70', 'bg-red-500/10', 'text-green-300', 'border-green-400/70', 'bg-green-500/10');

        if (isError) {
            banner.classList.add('text-red-300', 'border-red-400/70', 'bg-red-500/10');
        } else {
            banner.classList.add('text-green-300', 'border-green-400/70', 'bg-green-500/10');
        }

        clearTimeout(bannerTimeout);
        bannerTimeout = setTimeout(() => banner.classList.add('hidden'), 3500);
    }

    function showFeedback(message, isError = false) {
        showBanner(message, isError);
        showToast(message, isError);
    }

    function getNearestAllowedAspectRatio(value, fallback = '1:1') {
        if (!isFinite(value) || value <= 0) return fallback;
        let nearest = fallback;
        let smallestDiff = Infinity;

        ALLOWED_ASPECT_VALUES.forEach(({ ratio, value: allowedValue }) => {
            const diff = Math.abs(value - allowedValue);
            if (diff < smallestDiff) {
                smallestDiff = diff;
                nearest = ratio;
            }
        });

        return nearest;
    }

    function normalizeRatioNumber(value) {
        if (!Number.isFinite(value)) return null;
        if (Number.isInteger(value)) return String(value);
        const rounded = Number(value.toFixed(4));
        return String(rounded).replace(/\.0+$/, '').replace(/(\.\d+?)0+$/, '$1');
    }

    function normalizeRatioPair(raw, fallback = '1:1') {
        const normalized = String(raw || '').trim().replace('：', ':');
        if (!normalized) return fallback;
        if (!normalized.includes(':')) return null;
        const parts = normalized.split(':').map(part => part.trim());
        if (parts.length !== 2) return fallback;
        const w = Number(parts[0]);
        const h = Number(parts[1]);
        if (!Number.isFinite(w) || !Number.isFinite(h) || w <= 0 || h <= 0) return fallback;
        const wText = normalizeRatioNumber(w);
        const hText = normalizeRatioNumber(h);
        if (!wText || !hText) return fallback;
        return `${wText}:${hText}`;
    }

    function sanitizeAspectRatio(raw, fallback = '1:1') {
        if (!raw) return fallback;

        const normalized = String(raw).trim().replace('：', ':');
        if (ALLOWED_ASPECT_RATIOS.includes(normalized)) return normalized;

        if (normalized.includes(':')) {
            const normalizedPair = normalizeRatioPair(normalized, fallback);
            if (normalizedPair) return normalizedPair;
        }

        const numeric = Number(normalized);
        if (!Number.isNaN(numeric) && numeric > 0) {
            return getNearestAllowedAspectRatio(numeric, fallback);
        }

        return fallback;
    }

    function sanitizeResolution(raw, fallback = '1K') {
        if (!raw) return fallback;
        const normalized = String(raw).trim().toUpperCase();
        return ALLOWED_RESOLUTIONS.includes(normalized) ? normalized : fallback;
    }

    function clampTemperature(value, fallback = 0.7) {
        const num = Number(value);
        if (Number.isNaN(num)) return fallback;
        return Math.min(1, Math.max(0, num));
    }

    function parseDataUrl(dataUrl) {
        if (!dataUrl || !dataUrl.startsWith('data:')) return null;
        const [meta, base64] = dataUrl.split(',');
        if (!meta || !base64) return null;
        const match = meta.match(/data:(.*?);base64/i);
        return { base64, mimeType: match ? match[1] : 'image/png' };
    }

    function dataUrlFromBase64(base64, mimeType) {
        if (!base64) return '';
        return `data:${mimeType || 'image/png'};base64,${base64}`;
    }

    function setImageMeta(url, meta) {
        if (!url) return;
        const current = imageMeta.get(url) || {};
        const merged = { ...current, ...meta };
        if (merged.ratio) merged.ratio = sanitizeAspectRatio(merged.ratio);
        imageMeta.set(url, merged);
    }

    function simplifyRatio(width, height) {
        if (!width || !height) return null;
        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
        const divisor = gcd(width, height);
        return `${Math.round(width / divisor)}:${Math.round(height / divisor)}`;
    }

    async function deriveAspectRatio(url) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const numericRatio = img.naturalWidth / img.naturalHeight;
                resolve(getNearestAllowedAspectRatio(numericRatio));
            };
            img.onerror = () => resolve('1:1');
            img.src = url;
        });
    }

    function findInlineImage(parts) {
        if (!Array.isArray(parts)) return null;
        for (const part of parts) {
            if (part?.inline_data?.data && part.inline_data.mime_type) {
                return { data: part.inline_data.data, mimeType: part.inline_data.mime_type };
            }
            if (part?.inlineData?.data && part.inlineData.mimeType) {
                return { data: part.inlineData.data, mimeType: part.inlineData.mimeType };
            }
        }
        return null;
    }

    // --- Style Reference Helpers ---
    function updateStylePreview(previewUrl) {
        const container = document.getElementById('style-image-preview');
        const img = document.getElementById('style-image-preview-img');
        if (!container || !img) return;

        if (previewUrl) {
            img.src = previewUrl;
            container.classList.remove('hidden');
        } else {
            img.src = '';
            container.classList.add('hidden');
        }
    }

    function convertFileToBase64(file) {
        return new Promise((resolve, reject) => {
            try {
                console.log('画像の変換開始...');
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result;
                    if (typeof result !== 'string') {
                        return reject(new Error('画像の読み込みに失敗しました'));
                    }

                    const base64 = result.split(',')[1] || '';
                    console.log('変換完了');
                    resolve(base64);
                };

                reader.onerror = (error) => {
                    console.error('画像変換中にエラー', error);
                    reject(error || new Error('画像の読み込みに失敗しました'));
                };

                reader.readAsDataURL(file);
            } catch (error) {
                reject(error);
            }
        });
    }

    function clearStyleReferenceImage() {
        const input = document.getElementById('style-image-input');
        if (input) input.value = '';
        styleReferenceImage = null;
        updateStylePreview('');
    }

    async function handleStyleImageChange(event) {
        const file = event?.target?.files?.[0];
        if (!file) {
            clearStyleReferenceImage();
            return;
        }

        if (!file.type.startsWith('image/')) {
            showFeedback('画像ファイルを選択してください', true);
            clearStyleReferenceImage();
            return;
        }

        try {
            const base64 = await convertFileToBase64(file);
            const mimeType = file.type || 'image/png';
            styleReferenceImage = {
                data: base64,
                mimeType
            };
            const previewUrl = `data:${mimeType};base64,${base64}`;
            updateStylePreview(previewUrl);
        } catch (error) {
            showFeedback('画像の読み込みに失敗しました', true);
            clearStyleReferenceImage();
        }
    }

    async function loadApiKeyFromDB(userId) {
        if (!userId) return;
        const { data, error } = await supabaseClient
            .from('api_keys')
            .select('id, key')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(1)
            .maybeSingle();

        if (error) {
            console.warn('APIキーの取得に失敗しました', error);
            setApiKeyInputs('');
            currentApiKeyRecordId = null;
            return;
        }

        if (data) {
            currentApiKeyRecordId = data.id;
            const decryptedKey = data.key ? decryptApiKey(data.key) : '';
            setApiKeyInputs(decryptedKey);
        } else {
            currentApiKeyRecordId = null;
            setApiKeyInputs('');
        }
    }

    // --- Image History Helpers ---
    function resetHistoryState() {
        historyLoadedCount = 0;
        historyHasMore = false;
        historyLoading = false;
        imageHistory = [];
        const grid = document.getElementById('history-grid');
        const empty = document.getElementById('history-empty');
        const loadMore = document.getElementById('history-load-more');
        if (grid) grid.innerHTML = '';
        if (empty) empty.classList.remove('hidden');
        if (loadMore) loadMore.classList.add('hidden');
    }

    function createHistoryCard(entry) {
        const card = document.createElement('div');
        card.className = "bg-surface-dark border border-border-dark rounded-xl overflow-hidden shadow-lg shadow-black/30 hover:-translate-y-0.5 transition-transform duration-150";

        const imgWrap = document.createElement('div');
        imgWrap.className = "relative bg-black/40 cursor-pointer";

        const img = document.createElement('img');
        img.src = entry.image_url;
        img.className = "w-full h-48 object-cover";

        img.onload = () => {
            setImageMeta(entry.image_url, { prompt: entry.prompt, ratio: simplifyRatio(img.naturalWidth, img.naturalHeight), modelKey: 'gemini-3-pro-image-preview', referenceImage: entry.reference_image || null });
        };

        imgWrap.addEventListener('click', () => openModal(entry.image_url, entry.prompt, entry.reference_image || null));

        const expired = document.createElement('div');
        expired.className = "absolute inset-0 flex items-center justify-center text-[#ab9db9] text-sm bg-black/70 hidden";
        expired.innerText = "期限切れ";

        img.onerror = () => {
            img.classList.add('hidden');
            expired.classList.remove('hidden');
        };

        imgWrap.appendChild(img);
        imgWrap.appendChild(expired);

        const body = document.createElement('div');
        body.className = "p-4 space-y-2";

        const prompt = document.createElement('p');
        prompt.className = "text-sm text-white leading-relaxed max-h-[48px] overflow-hidden";
        prompt.textContent = entry.prompt || "";

        const meta = document.createElement('div');
        meta.className = "flex items-center justify-between text-[11px] text-[#ab9db9]";
        const date = new Date(entry.created_at || Date.now());

        const metaContent = document.createElement('span');
        metaContent.className = "flex items-center gap-1";
        const metaIcon = document.createElement('span');
        metaIcon.className = "material-symbols-outlined text-[14px]";
        metaIcon.textContent = 'history';
        const metaText = document.createElement('span');
        metaText.textContent = date.toLocaleString('ja-JP');

        metaContent.appendChild(metaIcon);
        metaContent.appendChild(metaText);
        meta.appendChild(metaContent);

        body.appendChild(prompt);
        body.appendChild(meta);

        card.appendChild(imgWrap);
        card.appendChild(body);

        return card;
    }

    function renderHistoryEntries(entries = [], { reset = false } = {}) {
        const section = document.getElementById('history-section');
        const grid = document.getElementById('history-grid');
        const empty = document.getElementById('history-empty');
        const loadMore = document.getElementById('history-load-more');
        if (!section || !grid || !empty || !loadMore) return;

        if (!currentUserId) {
            section.classList.add('hidden');
            resetHistoryState();
            return;
        }

        section.classList.remove('hidden');

        if (reset) {
            grid.innerHTML = '';
        }

        entries.forEach(entry => {
            grid.appendChild(createHistoryCard(entry));
        });

        const hasEntries = grid.children.length > 0;
        empty.classList.toggle('hidden', hasEntries);
        loadMore.classList.toggle('hidden', !historyHasMore);
    }

    async function loadHistory() {
        if (!currentUserId || historyLoading) return;

        const loadMore = document.getElementById('history-load-more');
        historyLoading = true;
        if (loadMore) {
            loadMore.disabled = true;
            loadMore.textContent = '読み込み中...';
        }

        let query = supabaseClient
            .from('generated_images')
            .select('id, image_base64, mime_type, created_at, generations!inner(prompt, reference_image_base64, reference_image_mime, created_at)')
            .order('created_at', { ascending: false });

        const keyword = currentSearchQuery?.trim();
        if (keyword) {
            query = query.ilike('generations.prompt', `%${keyword}%`);
        }

        const start = historyLoadedCount;
        const end = historyLoadedCount + HISTORY_PAGE_SIZE - 1;
        const { data, error } = await query.range(start, end);

        historyLoading = false;
        if (loadMore) {
            loadMore.disabled = false;
            loadMore.textContent = 'もっと見る';
        }

        if (error) {
            console.warn('履歴の取得に失敗しました', error);
            return;
        }

        const results = (data || []).map(row => ({
            id: row.id,
            prompt: row.generations?.prompt || '',
            image_url: dataUrlFromBase64(row.image_base64, row.mime_type),
            reference_image: dataUrlFromBase64(row.generations?.reference_image_base64, row.generations?.reference_image_mime),
            created_at: row.generations?.created_at || row.created_at,
        }));
        const isFirstPage = historyLoadedCount === 0;
        imageHistory.push(...results);
        historyLoadedCount += results.length;
        historyHasMore = results.length === HISTORY_PAGE_SIZE;

        renderHistoryEntries(results, { reset: isFirstPage });

        if (isFirstPage && results.length === 0) {
            renderHistoryEntries([], { reset: true });
        }
    }

    async function refreshHistoryFromStart() {
        resetHistoryState();
        await loadHistory();
    }

    async function handleHistorySearch() {
        const input = document.getElementById('history-search-input');
        currentSearchQuery = input?.value.trim() || '';
        await refreshHistoryFromStart();
    }

    async function saveGenerationHistory({ prompt, aspectRatio, resolution, temperature, imageCount, referenceImage, images }) {
        if (!currentUserId || !prompt || !images?.length) return;

        const parsedImages = images
            .map((image) => parseDataUrl(image.url))
            .filter((parsed) => parsed?.base64);

        if (!parsedImages.length) return;

        const generationPayload = {
            prompt,
            aspect_ratio: sanitizeAspectRatio(aspectRatio),
            resolution: sanitizeResolution(resolution),
            temperature: clampTemperature(temperature),
            image_count: imageCount,
            reference_image_base64: referenceImage?.data || null,
            reference_image_mime: referenceImage?.mimeType || null,
        };

        const { data: generation, error: generationError } = await supabaseClient
            .from('generations')
            .insert([generationPayload])
            .select('id')
            .single();

        if (generationError || !generation) {
            console.warn('生成履歴の保存に失敗しました', generationError);
            return;
        }

        const imageRows = parsedImages.map(parsed => ({
            generation_id: generation.id,
            image_base64: parsed.base64,
            mime_type: parsed.mimeType || 'image/png',
        }));

        const { error: imageError } = await supabaseClient
            .from('generated_images')
            .insert(imageRows);

        if (imageError) {
            console.warn('生成画像の保存に失敗しました', imageError);
            return;
        }

        await refreshHistoryFromStart();
    }

    function openSettingsPanel() {
        const modal = document.getElementById('settings-modal');
        modal.classList.remove('hidden');
        const currentValue = document.getElementById('settings-api-key-input')?.value || '';
        setApiKeyInputs(currentValue);
        const status = document.getElementById('settings-save-status');
        status.classList.add('opacity-0');
    }

    function closeSettingsPanel() {
        document.getElementById('settings-modal').classList.add('hidden');
    }

    async function saveApiKeyFromSettings() {
        if (!currentUserId) {
            showFeedback('ログイン後にAPIキーを保存してください', true);
            return;
        }
        const value = document.getElementById('settings-api-key-input').value.trim();
        const encryptedKey = value ? encryptApiKey(value) : '';
        const payload = {
            user_id: currentUserId,
            name: 'default',
            key: encryptedKey,
        };

        let response;
        if (currentApiKeyRecordId) {
            response = await supabaseClient
                .from('api_keys')
                .update(payload)
                .eq('id', currentApiKeyRecordId)
                .eq('user_id', currentUserId)
                .select('id')
                .single();
        } else {
            const insertPayload = { ...payload, id: crypto.randomUUID() };
            response = await supabaseClient
                .from('api_keys')
                .insert([insertPayload])
                .select('id')
                .single();
        }

        const { data, error } = response || {};

        const status = document.getElementById('settings-save-status');
        if (error) {
            console.warn('APIキーの保存に失敗しました', error);
            status.textContent = 'APIキーの保存に失敗しました。';
            status.classList.remove('text-green-400');
            status.classList.add('text-red-400');
            showFeedback('APIキーの保存に失敗しました。', true);
        } else {
            currentApiKeyRecordId = data.id;
            setApiKeyInputs(value);
            status.textContent = 'APIキーを保存しました。';
            status.classList.remove('text-red-400');
            status.classList.add('text-green-400');
            showFeedback('APIキーを保存しました。');
        }

        status.classList.remove('opacity-0');
        setTimeout(() => status.classList.add('opacity-0'), 2000);
    }

    // --- Auth Helpers ---
    function updateAuthModeUI() {
        const title = document.getElementById('auth-title');
        const submit = document.getElementById('auth-submit');
        const toggle = document.getElementById('auth-toggle');
        const passwordConfirm = document.getElementById('password-confirm-container');

        title.innerText = isSignupMode ? '新規登録' : 'ログイン';
        submit.innerText = isSignupMode ? '新規登録' : 'ログイン';
        toggle.innerText = isSignupMode ? 'ログインに切り替え' : '新規登録に切り替え';
        passwordConfirm.classList.toggle('hidden', !isSignupMode);
        clearAuthError();
    }

    function clearAuthError() {
        const errorBox = document.getElementById('auth-error');
        errorBox.classList.add('hidden');
        errorBox.textContent = '';
    }

    function showAuthError(message) {
        const errorBox = document.getElementById('auth-error');
        errorBox.textContent = message;
        errorBox.classList.remove('hidden');
        showFeedback(message, true);
    }

    function formatAuthError(message) {
        if (message.includes('User already registered')) return 'そのメールアドレスは既に使われています。';
        if (message.includes('Invalid login credentials')) return 'メールアドレスまたはパスワードが正しくありません。';
        return `エラーが発生しました: ${message}`;
    }

    function extractUsername(email) {
        if (!email) return '';
        const [local] = email.split('@');
        return local || email;
    }

    function clearInMemoryData() {
        templates = [];
        selectedTemplateId = null;
        setApiKeyInputs('');
        renderSidebar();
    }

    function showAuthScreen() {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('app-shell').classList.add('hidden');
        document.getElementById('logout-button').classList.add('hidden');
        document.getElementById('logged-in-user').classList.add('hidden');
        document.getElementById('settings-fab').classList.add('hidden');
        currentUserId = null;
        currentApiKeyRecordId = null;
        clearInMemoryData();
        currentSearchQuery = "";
        const searchInput = document.getElementById('history-search-input');
        if (searchInput) searchInput.value = '';
        renderHistoryEntries([], { reset: true });
    }

    async function showAppShell(user) {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-shell').classList.remove('hidden');
        const userBadge = document.getElementById('logged-in-user');
        const username = extractUsername(user?.email);
        if (username) {
            userBadge.textContent = `ログイン中：${username}`;
            userBadge.classList.remove('hidden');
        }
        document.getElementById('logout-button').classList.remove('hidden');
        document.getElementById('settings-fab').classList.remove('hidden');
        currentUserId = user?.id || null;
        currentSearchQuery = "";
        resetHistoryState();
        const searchInput = document.getElementById('history-search-input');
        if (searchInput) searchInput.value = '';
        await Promise.all([
            loadTemplates(currentUserId),
            loadApiKeyFromDB(currentUserId),
        ]);
        await loadHistory();
    }

    async function handleAuthSubmit(event) {
        event.preventDefault();
        clearAuthError();

        const email = document.getElementById('email-input').value.trim();
        const password = document.getElementById('password-input').value;
        const passwordConfirm = document.getElementById('password-confirm-input').value;

        if (!email || !password) return showAuthError('メールアドレスとパスワードを入力してください。');
        if (isSignupMode && password !== passwordConfirm) return showAuthError('確認用パスワードが一致しません。');

        const submitBtn = document.getElementById('auth-submit');
        submitBtn.disabled = true;
        submitBtn.innerText = isSignupMode ? '登録中...' : 'ログイン中...';

        let error;
        if (isSignupMode) {
            ({ error } = await supabaseClient.auth.signUp({ email, password }));
            if (!error) {
                const { error: signInError } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (signInError) error = signInError;
            }
        } else {
            ({ error } = await supabaseClient.auth.signInWithPassword({ email, password }));
        }

        if (error) {
            showAuthError(formatAuthError(error.message));
        } else {
            document.getElementById('password-input').value = '';
            document.getElementById('password-confirm-input').value = '';
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session?.user) await showAppShell(session.user);
        }

        submitBtn.disabled = false;
        submitBtn.innerText = isSignupMode ? '新規登録' : 'ログイン';
    }

    async function handleLogout() {
        await supabaseClient.auth.signOut();
        showAuthScreen();
    }

    async function refreshSessionUI() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session?.user) {
            await showAppShell(session.user);
        } else {
            showAuthScreen();
        }
    }

    function setupAuthListeners() {
        document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit);
        document.getElementById('auth-submit').addEventListener('click', (event) => {
            event.preventDefault();
            handleAuthSubmit(event);
        });
        document.getElementById('auth-toggle').addEventListener('click', () => {
            isSignupMode = !isSignupMode;
            updateAuthModeUI();
        });
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        supabaseClient.auth.onAuthStateChange(async (_event, session) => {
            if (session?.user) {
                await showAppShell(session.user);
            } else {
                showAuthScreen();
            }
        });
        updateAuthModeUI();
        refreshSessionUI();
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        initModelSelect();
        setupAuthListeners();

        const styleInput = document.getElementById('style-image-input');
        if (styleInput) styleInput.addEventListener('change', handleStyleImageChange);

        const clearBtn = document.getElementById('style-image-clear');
        if (clearBtn) clearBtn.addEventListener('click', clearStyleReferenceImage);

        const generateButton = document.getElementById('generate-btn');
        if (generateButton) {
            generateButton.addEventListener('click', (event) => {
                event.preventDefault();
                handleGenerate();
            });
        }

        const historySearchBtn = document.getElementById('history-search-btn');
        const historySearchInput = document.getElementById('history-search-input');
        if (historySearchBtn) historySearchBtn.addEventListener('click', handleHistorySearch);
        if (historySearchInput) {
            historySearchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleHistorySearch();
                }
            });
        }

        const historyLoadMore = document.getElementById('history-load-more');
        if (historyLoadMore) historyLoadMore.addEventListener('click', () => loadHistory());

        const tempSlider = document.getElementById('gen-temperature');
        const tempDisplay = document.getElementById('gen-temperature-display');
        if (tempSlider && tempDisplay) {
            const updateTemp = () => {
                const value = clampTemperature(tempSlider.value, 0.7);
                tempSlider.value = value.toFixed(2);
                tempDisplay.textContent = Number(value).toFixed(2);
            };
            tempSlider.addEventListener('input', updateTemp);
            updateTemp();
        }

        const templateApplyBtn = document.getElementById('prompt-template-apply');
        if (templateApplyBtn) {
            templateApplyBtn.addEventListener('click', (event) => {
                event.preventDefault();
                applyTemplateToPrompt();
            });
        }
    });

    function initModelSelect() {
        const select = document.getElementById('model-select');
        select.innerHTML = '';
        Object.keys(MODELS).forEach(key => {
            const m = MODELS[key];
            const option = document.createElement('option');
            option.value = key;
            option.text = m.name;
            select.appendChild(option);
        });
        changeModel();
    }

    function changeModel() {
        const select = document.getElementById('model-select');
        activeModelKey = select.value;
        const model = MODELS[activeModelKey];
        document.getElementById('model-id-display').innerText = model.id;
        document.getElementById('model-cost-display').innerText = `$${model.cost}/img`;
    }

    function extractFieldsFromPrompt(prompt) {
        const regex = /\{\{(.+?)\}\}/g;
        let match;
        const fields = new Set();
        while ((match = regex.exec(prompt)) !== null) {
            fields.add(match[1]);
        }
        return Array.from(fields);
    }

    function mapTemplateRow(row) {
        let parsedContent = null;
        try {
            parsedContent = JSON.parse(row.content);
        } catch (_) {
            parsedContent = null;
        }

        const prompt = parsedContent?.prompt || row.content || '';
        const aspectRatio = sanitizeAspectRatio(parsedContent?.aspectRatio || '1:1');
        const fields = parsedContent?.fields || extractFieldsFromPrompt(prompt);

        return {
            id: row.id,
            name: row.title,
            prompt,
            aspectRatio,
            fields,
        };
    }

    async function loadTemplates(userId) {
        if (!userId) {
            templates = DEFAULT_TEMPLATES;
            renderSidebar();
            return;
        }

        const { data, error } = await supabaseClient
            .from('templates')
            .select('id, title, content')
            .eq('user_id', userId)
            .order('created_at', { ascending: true });

        if (error) {
            console.warn('テンプレートの取得に失敗しました', error);
            templates = DEFAULT_TEMPLATES;
            renderSidebar();
            return;
        }

        templates = (data || []).map(mapTemplateRow);

        renderSidebar();
    }

    // --- NAVIGATION ---
    function switchView(viewName) {
        const editor = document.getElementById('view-editor');
        const historyView = document.getElementById('view-history');

        if (viewName === 'editor') {
            editor.classList.remove('translate-x-full');
        } else {
            editor.classList.add('translate-x-full');
        }

        if (viewName === 'history') {
            historyView.classList.remove('translate-x-full');
        } else {
            historyView.classList.add('translate-x-full');
        }
    }

    function openHistory() {
        if (!currentUserId) {
            showFeedback('ログイン後に履歴を確認できます', true);
            return;
        }
        if (historyLoadedCount === 0 && !historyLoading) {
            refreshHistoryFromStart();
        }
        switchView('history');
    }

    // --- SIDEBAR LOGIC ---
    function renderSidebar() {
        const list = document.getElementById('template-list');
        list.innerHTML = '';

        templates.forEach(t => {
            const div = document.createElement('div');
            // ランダムグラデーション
            const hash = t.id.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
            const hue = Math.abs(hash) % 360;
            const gradient = `background: linear-gradient(135deg, hsl(${hue}, 70%, 60%), hsl(${hue+40}, 70%, 50%))`;
            const isSelected = t.id === selectedTemplateId;

            div.className = `flex items-center justify-between p-2 rounded-lg group transition-all border cursor-pointer ${isSelected ? 'bg-primary/10 border-primary shadow-lg' : 'border-transparent hover:bg-white/5 hover:border-border-dark'}`;
            div.onclick = (e) => {
                if(!e.target.closest('button')) selectTemplateForGen(t.id);
            };

            const nameClass = isSelected ? 'text-sm font-medium text-primary truncate' : 'text-sm font-medium text-gray-200 group-hover:text-primary transition-colors truncate';
            const metaClass = isSelected ? 'text-[10px] text-primary/80 truncate' : 'text-[10px] text-[#ab9db9] truncate';

            div.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="size-8 rounded flex-shrink-0" style="${gradient}"></div>
                    <div class="min-w-0">
                        <p class="${nameClass}">${t.name}</p>
                        <p class="${metaClass}">${t.fields.length} variables • ${t.aspectRatio}</p>
                    </div>
                </div>
                <div class="flex ${isSelected ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} transition-opacity">
                    <button onclick="openEditor('${t.id}')" class="p-1 hover:text-white text-gray-500" title="編集">
                        <span class="material-symbols-outlined text-sm">edit</span>
                    </button>
                    <button onclick="openDeleteModal('${t.id}')" class="p-1 hover:text-red-400 text-gray-500" title="削除">
                        <span class="material-symbols-outlined text-sm">delete</span>
                    </button>
                </div>
            `;
            list.appendChild(div);
        });

        updateSelectedTemplateBadge();
        renderTemplateSelectOptions();
    }

    function renderTemplateSelectOptions() {
        const select = document.getElementById('prompt-template-select');
        if (!select) return;
        select.innerHTML = '';

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'テンプレートを選択...';
        select.appendChild(placeholder);

        templates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.id;
            option.textContent = template.name;
            select.appendChild(option);
        });
    }

    function applyTemplateToPrompt() {
        const select = document.getElementById('prompt-template-select');
        const promptInput = document.getElementById('prompt-input');
        if (!select || !promptInput) return;

        const templateId = select.value;
        if (!templateId) {
            showFeedback('挿入するテンプレートを選択してください', true);
            return;
        }

        const tmpl = templates.find(t => t.id === templateId);
        if (!tmpl) return;

        promptInput.value = tmpl.prompt;
        const arSelect = document.getElementById('gen-aspect-ratio');
        if (arSelect) arSelect.value = sanitizeAspectRatio(tmpl.aspectRatio);
        showFeedback(`テンプレート「${tmpl.name}」を挿入しました`);
        select.value = '';
    }

    // --- GENERATOR LOGIC ---
    function setGenMode(mode) {
        currentGenMode = mode;
        const freeBtn = document.getElementById('mode-free');
        const tmplBtn = document.getElementById('mode-template');
        const freeInput = document.getElementById('input-free');
        const tmplInput = document.getElementById('input-template');

        if (mode === 'free') {
            freeBtn.className = "px-4 py-2 rounded-lg bg-primary text-white shadow-sm text-sm font-bold transition-all flex items-center gap-2";
            tmplBtn.className = "px-4 py-2 rounded-lg text-[#ab9db9] hover:text-white hover:bg-white/5 text-sm font-medium transition-all flex items-center gap-2";
            freeInput.classList.remove('hidden');
            tmplInput.classList.add('hidden');
        } else {
            freeBtn.className = "px-4 py-2 rounded-lg text-[#ab9db9] hover:text-white hover:bg-white/5 text-sm font-medium transition-all flex items-center gap-2";
            tmplBtn.className = "px-4 py-2 rounded-lg bg-primary text-white shadow-sm text-sm font-bold transition-all flex items-center gap-2";
            freeInput.classList.add('hidden');
            tmplInput.classList.remove('hidden');
        }
    }

    function selectTemplateForGen(id) {
        selectedTemplateId = id;
        const tmpl = templates.find(t => t.id === id);
        if (!tmpl) return;

        setGenMode('template');
        const arSelect = document.getElementById('gen-aspect-ratio');
        if (arSelect) arSelect.value = sanitizeAspectRatio(tmpl.aspectRatio);

        const container = document.getElementById('template-form-container');
        container.innerHTML = '';

        if (tmpl.fields.length === 0) {
            container.innerHTML = `<div class="col-span-2 text-center text-[#ab9db9] text-sm pt-4">変数はありません。そのまま生成できます。</div>`;
        } else {
            tmpl.fields.forEach(field => {
                const div = document.createElement('div');
                div.className = "flex flex-col gap-1";
                div.innerHTML = `
                    <label class="text-[10px] font-bold text-[#ab9db9] uppercase">${field}</label>
                    <input type="text" id="gen-field-${field}" placeholder="Value for ${field}..." class="w-full bg-[#2d2836] border border-border-dark rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-primary transition-all">
                `;
                container.appendChild(div);
            });
        }

        updateSelectedTemplateBadge();
        renderSidebar();
    }

    function updateSelectedTemplateBadge() {
        const pill = document.getElementById('selected-template-pill');
        const nameSpan = document.getElementById('selected-template-name');
        if (!pill || !nameSpan) return;

        if (!selectedTemplateId) {
            pill.classList.add('hidden');
            nameSpan.innerText = '';
            return;
        }

        const tmpl = templates.find(t => t.id === selectedTemplateId);
        if (!tmpl) {
            pill.classList.add('hidden');
            nameSpan.innerText = '';
            return;
        }

        nameSpan.innerText = tmpl.name;
        pill.classList.remove('hidden');
    }

    const generationQueue = [];
    const MAX_CONCURRENT = 3;
    let activeGenerations = 0;

    function enqueueTask(task) {
        generationQueue.push(task);
        processQueue();
    }

    async function executeGenerationTask(nextTask) {
        try {
            if (nextTask.type === 'generate') {
                updatePlaceholderStatus(nextTask.placeholderId, '🤖 生成中...');
                await runGenerationTask(nextTask);
            } else if (nextTask.type === 'upscale_4k') {
                if (nextTask.placeholderId) {
                    updatePlaceholderStatus(nextTask.placeholderId, '🤖 4K生成中...');
                }
                await runUpscale4kTask(nextTask);
            }
        } catch (err) {
            console.error(err);
            const message = err?.message || '生成に失敗しました';
            if (nextTask.placeholderId) {
                updatePlaceholderWithError(nextTask.placeholderId, message);
            }
            if (nextTask.type === 'upscale_4k') {
                showFeedback(`4K生成に失敗しました: ${message}`, true);
            } else {
                showFeedback(`画像生成に失敗しました: ${message}`, true);
            }
        } finally {
            console.log('🏁 タスク終了');
            activeGenerations = Math.max(0, activeGenerations - 1);
            processQueue();
        }
    }

    async function processQueue() {
        while (generationQueue.length > 0 && activeGenerations < MAX_CONCURRENT) {
            const nextTask = generationQueue.shift();
            if (!nextTask) continue;

            activeGenerations++;
            console.log('🚀 生成タスク開始', nextTask, `アクティブ: ${activeGenerations}/${MAX_CONCURRENT}`);

            executeGenerationTask(nextTask);
        }
    }

    async function handleGenerate() {
        // 1. Prepare Params
        const apiKey = document.getElementById('settings-api-key-input').value;
        const aspectRatio = sanitizeAspectRatio(document.getElementById('gen-aspect-ratio').value);
        document.getElementById('gen-aspect-ratio').value = aspectRatio;
        const count = parseInt(document.getElementById('gen-count').value) || 1;
        const resolution = sanitizeResolution(document.getElementById('gen-resolution').value);
        document.getElementById('gen-resolution').value = resolution;
        const temperature = clampTemperature(document.getElementById('gen-temperature').value);
        const snapshotModelKey = activeModelKey;
        const activeModel = MODELS[snapshotModelKey];
        const styleReference = styleReferenceImage ? { ...styleReferenceImage } : null;

        if (!activeModel) {
            return showFeedback("モデルを選択してください", true);
        }

        // 2. Prepare Prompt
        let finalPrompt = "";
        if (currentGenMode === 'free') {
            finalPrompt = document.getElementById('prompt-input').value;
        } else {
            if (!selectedTemplateId) return showFeedback("テンプレートを選択してください", true);
            const tmpl = templates.find(t => t.id === selectedTemplateId);
            finalPrompt = tmpl.prompt;
            tmpl.fields.forEach(f => {
                const val = document.getElementById(`gen-field-${f}`).value || "";
                finalPrompt = finalPrompt.replace(new RegExp(`{{${f}}}`, 'g'), val);
            });
        }

        if (!finalPrompt.trim()) return showFeedback("プロンプトを入力してください", true);

        // 3. Demo check
        let isDemoMode = false;
        if (!apiKey) {
            showFeedback('API Keyが未入力のためデモモードで実行します。');
            isDemoMode = true;
        }

        addMessage(finalPrompt, 'user');
        const placeholderId = addGenerationPlaceholder('🤖 生成中...（待機中）');

        const request = { apiKey, aspectRatio, resolution, temperature, count, snapshotModelKey, finalPrompt, isDemoMode, styleReference };
        enqueueTask({ type: 'generate', request, placeholderId });

        const promptInput = document.getElementById('prompt-input');
        if (promptInput) promptInput.value = '';
        document.querySelectorAll('[id^="gen-field-"]').forEach(input => { input.value = ''; });
    }

    async function runGenerationTask({ request, placeholderId }) {
        const { apiKey, aspectRatio, resolution, temperature, count, snapshotModelKey, finalPrompt, isDemoMode, styleReference } = request;
        const activeModel = MODELS[snapshotModelKey];
        if (!activeModel) {
            showFeedback("モデルを選択してください", true);
            return;
        }

        updatePlaceholderStatus(placeholderId, '🤖 生成中...');

        const results = new Array(count);
        const errors = [];

        const basePrompt = finalPrompt.trim();
        const styleImageBase64 = styleReference?.data;
        const styleMimeType = styleReference?.mimeType || 'image/png';

        const buildGeminiRequestBody = (is4K = false) => {
            const parts = [{ text: basePrompt }];
            if (styleImageBase64) {
                parts[0].text += " Apply the artistic style, color palette, and texture of the provided reference image.";
                parts.push({
                    inline_data: {
                        mime_type: styleMimeType,
                        data: styleImageBase64
                    }
                });
            }

            const imageConfig = { aspect_ratio: aspectRatio };
            const imageSize = is4K
                ? '4K'
                : (activeModel.id === 'gemini-3-pro-image-preview' ? resolution : undefined);
            if (imageSize) {
                imageConfig.image_size = imageSize;
            }

            return {
                contents: [{ parts }],
                generationConfig: {
                    image_config: imageConfig,
                    temperature: clampTemperature(temperature)
                }
            };
        };

        const promptForRequest = buildGeminiRequestBody().contents[0].parts[0].text;
        const referenceDataUrl = styleReference
            ? `data:${styleMimeType};base64,${styleImageBase64}`
            : null;

        try {
            const promises = new Array(count).fill(null).map(async (_unused, idx) => {
                try {
                    let imageUrl = "";
                    let finalCost = "0.00";

                    if (isDemoMode) {
                        await new Promise(r => setTimeout(r, 1500 + Math.random() * 1000));
                        const seed = Math.floor(Math.random() * 10000);
                        const [rw, rh] = aspectRatio.split(':').map(Number);
                        const baseSize = 800;
                        const w = Math.round(baseSize * (rw / Math.sqrt(rw * rh)));
                        const h = Math.round(baseSize * (rh / Math.sqrt(rw * rh)));
                        imageUrl = `https://picsum.photos/seed/${seed}/${w}/${h}`;
                        finalCost = "0.00 (Demo)";

                    } else {
                        let url = "";
                        let requestBody = {};

                        if (activeModel.type === "gemini") {
                            url = `https://generativelanguage.googleapis.com/v1beta/models/${activeModel.id}:generateContent?key=${apiKey}`;
                            requestBody = buildGeminiRequestBody(false);
                        } else {
                            url = `${activeModel.endpointBase}?key=${apiKey}`;
                            requestBody = {
                                "instances": [ { "prompt": promptForRequest } ],
                                "parameters": { "sampleCount": 1, "aspectRatio": aspectRatio, "temperature": clampTemperature(temperature) }
                            };
                        }

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        if (!response.ok) {
                            const errText = await response.text();
                            throw new Error(`API Error ${response.status}: ${errText}`);
                        }

                        const data = await response.json();

                        if (activeModel.type === "gemini") {
                            const parts = data.candidates?.[0]?.content?.parts;
                            const imagePart = findInlineImage(parts);
                            if (imagePart) {
                                imageUrl = `data:${imagePart.mimeType};base64,${imagePart.data}`;
                            } else {
                                throw new Error("Image blocked or failed (No inline data)");
                            }
                        } else {
                            if (data.predictions && data.predictions[0]?.bytesBase64Encoded) {
                                imageUrl = "data:image/png;base64," + data.predictions[0].bytesBase64Encoded;
                            } else if (data.images && data.images[0]) {
                                 imageUrl = data.images[0];
                            } else {
                                throw new Error("Unexpected Imagen response");
                            }
                        }
                        finalCost = activeModel.cost;
                    }

                    results[idx] = { url: imageUrl, modelName: activeModel.name, ratio: aspectRatio, prompt: promptForRequest, modelKey: snapshotModelKey, referenceImage: referenceDataUrl };

                } catch (e) {
                    const message = e?.message || '生成に失敗しました';
                    console.error(e);
                    errors.push(message);
                    updatePlaceholderWithError(placeholderId, message);
                    showToast(`画像生成に失敗しました: ${message}`, true);
                }
            });

            await Promise.allSettled(promises);

            const validResults = results.filter(r => r && r.url);

            if (validResults.length === 0) {
                const joinedError = errors.filter(Boolean).join(' / ') || '生成に失敗しました';
                updatePlaceholderWithError(placeholderId, joinedError);
                showFeedback(`画像生成に失敗しました: ${joinedError}`, true);
                return;
            }

            validResults.forEach(res => {
                setImageMeta(res.url, { prompt: res.prompt, ratio: res.ratio, modelKey: res.modelKey, referenceImage: res.referenceImage || null });
            });

            await saveGenerationHistory({
                prompt: promptForRequest,
                aspectRatio,
                resolution,
                temperature,
                imageCount: count,
                referenceImage: styleReference,
                images: validResults,
            });

            renderResultsInPlaceholder(placeholderId, validResults, activeModel.name);
        } catch (err) {
            const fallbackMessage = err?.message || '生成に失敗しました';
            console.error(err);
            updatePlaceholderWithError(placeholderId, fallbackMessage);
            showToast(`画像生成に失敗しました: ${fallbackMessage}`, true);
        }
    }

    // --- EDITOR LOGIC ---
    function openEditor(id = null) {
        switchView('editor');
        const title = document.getElementById('editor-title');
        const nameInput = document.getElementById('editor-name');
        const promptInput = document.getElementById('editor-prompt');
        const idInput = document.getElementById('editor-id');
        const arSelect = document.getElementById('editor-aspect-ratio');
        
        if (id) {
            const tmpl = templates.find(t => t.id === id);
            title.innerText = "テンプレート編集";
            nameInput.value = tmpl.name;
            promptInput.value = tmpl.prompt;
            idInput.value = tmpl.id;
            arSelect.value = sanitizeAspectRatio(tmpl.aspectRatio);
        } else {
            title.innerText = "テンプレート作成";
            nameInput.value = "";
            promptInput.value = "";
            idInput.value = "";
            arSelect.value = "1:1";
        }
    }

    function insertVariable() {
        const textarea = document.getElementById('editor-prompt');
        const cursor = textarea.selectionStart;
        const text = textarea.value;
        const insert = "{{変数}}";
        textarea.value = text.slice(0, cursor) + insert + text.slice(cursor);
        textarea.focus();
        textarea.selectionStart = cursor + 2;
        textarea.selectionEnd = cursor + 4;
    }

    async function saveTemplate() {
        if (!currentUserId) {
            showFeedback('テンプレートの保存にはログインが必要です', true);
            return;
        }
        const saveBtn = document.getElementById('save-template-button');
        if (saveBtn) saveBtn.disabled = true;

        try {
            const idInput = document.getElementById('editor-id');
            const name = document.getElementById('editor-name').value.trim();
            const prompt = document.getElementById('editor-prompt').value.trim();
            const ar = sanitizeAspectRatio(document.getElementById('editor-aspect-ratio').value);
            document.getElementById('editor-aspect-ratio').value = ar;

            if (!name) {
                showFeedback('テンプレート名を入力してください。', true);
                return;
            }

            if (!prompt) {
                showFeedback('プロンプト本文を入力してください。', true);
                return;
            }

            const fields = new Set(extractFieldsFromPrompt(prompt));

            const existingId = idInput.value.trim();
            const templateId = existingId || crypto.randomUUID();

            const payload = {
                title: name,
                content: JSON.stringify({
                    prompt: prompt,
                    aspectRatio: ar,
                    fields: Array.from(fields),
                }),
                user_id: currentUserId,
            };

            let error = null;
            let savedRow = null;
            if (existingId) {
                const response = await supabaseClient
                    .from('templates')
                    .update(payload)
                    .eq('id', existingId)
                    .eq('user_id', currentUserId)
                    .select()
                    .single();
                error = response.error;
                savedRow = response.data;
            } else {
                const insertPayload = { ...payload, id: templateId };
                const response = await supabaseClient
                    .from('templates')
                    .insert([insertPayload])
                    .select()
                    .single();
                error = response.error;
                savedRow = response.data;
            }
            if (error) {
                console.warn('テンプレートの保存に失敗しました', error);
                showFeedback('テンプレートの保存に失敗しました。時間をおいて再度お試しください。', true);
                return;
            }

            const latestTemplate = savedRow ? mapTemplateRow(savedRow) : {
                id: templateId,
                name,
                prompt,
                aspectRatio: ar,
                fields: Array.from(fields),
            };

            // DB 更新内容を確実に反映させるため、最新のテンプレートを再取得
            await loadTemplates(currentUserId);
            switchView('dashboard');
            selectTemplateForGen(latestTemplate.id);
            showFeedback('テンプレートを保存しました');
        } finally {
            if (saveBtn) saveBtn.disabled = false;
        }
    }

    function openDeleteModal(id) {
        pendingDeleteTemplateId = id;
        const modal = document.getElementById('delete-confirm-modal');
        const nameEl = document.getElementById('delete-template-name');
        const tmpl = templates.find(t => t.id === id);
        if (nameEl) nameEl.textContent = tmpl?.name || '';
        if (modal) modal.classList.remove('hidden');
    }

    function closeDeleteModal() {
        pendingDeleteTemplateId = null;
        const modal = document.getElementById('delete-confirm-modal');
        if (modal) modal.classList.add('hidden');
    }

    async function confirmDeleteTemplate() {
        if (!pendingDeleteTemplateId) return;
        await deleteTemplate(pendingDeleteTemplateId);
    }

    async function deleteTemplate(id) {
        if (!currentUserId) return showFeedback('ログイン後に削除してください', true);

        const { error } = await supabaseClient
            .from('templates')
            .delete()
            .eq('id', id)
            .eq('user_id', currentUserId);

        if (error) {
            console.warn('テンプレートの削除に失敗しました', error);
            showFeedback('テンプレートの削除に失敗しました', true);
            return;
        }

        closeDeleteModal();
        templates = templates.filter(t => t.id !== id);
        if (selectedTemplateId === id) {
            selectedTemplateId = null;
            setGenMode('free');
        }
        updateSelectedTemplateBadge();
        renderSidebar();
    }

    // --- DOM HELPERS (Chat) ---
    function addMessage(text, role) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = "flex items-end gap-3 justify-end group fade-in";
        div.innerHTML = `
            <div class="px-5 py-3 bg-[#2d2836] border border-border-dark text-white rounded-2xl rounded-tr-sm text-sm leading-relaxed shadow-sm max-w-[80%]">
                ${text}
            </div>
        `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function addGenerationPlaceholder(statusText = '🤖 生成中...（待機中）') {
        const container = document.getElementById('chat-container');
        const id = 'placeholder-' + Date.now() + Math.random();
        const wrapper = document.createElement('div');
        wrapper.id = id;
        wrapper.className = "flex items-start gap-3 justify-start max-w-[80%] fade-in mb-4";
        wrapper.innerHTML = `
            <div class="size-8 flex items-center justify-center bg-primary rounded-full shrink-0 animate-pulse">
                <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
            </div>
            <div class="flex-1 bg-surface-dark border border-border-dark rounded-2xl rounded-tl-sm p-4 shadow-xl placeholder-content" id="${id}-content">
                 <div class="flex items-center gap-2 text-[#ab9db9] text-sm" id="${id}-status">${statusText}</div>
            </div>
        `;
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
        return id;
    }

    function updatePlaceholderStatus(id, text) {
        const statusEl = document.getElementById(`${id}-status`);
        if (statusEl) statusEl.textContent = text;
    }

    function updatePlaceholderWithError(id, text) {
        const content = document.getElementById(`${id}-content`);
        if (!content) return;
        content.innerHTML = `<div class="text-red-400 bg-red-900/20 p-3 rounded text-xs">Error: ${text}</div>`;
    }

    function renderResultsInPlaceholder(id, results, modelName) {
        const content = document.getElementById(`${id}-content`);
        if (!content) return;
        content.innerHTML = '';

        if (results.length > 1) {
            const card = document.createElement('div');
            card.className = "bg-surface-dark rounded-2xl border border-white/5 overflow-hidden shadow-xl flex-1";

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 sm:grid-cols-2 gap-3 p-3 bg-black/30";

            results.forEach((res, index) => {
                const item = document.createElement('div');
                item.className = "relative cursor-pointer overflow-hidden bg-black/50 rounded-xl border border-border-dark";

                const img = document.createElement('img');
                img.src = res.url;
                img.className = "w-full h-auto max-h-[320px] object-contain";
                img.onclick = () => openModal(res.url, res.prompt);

                const badge = document.createElement('div');
                badge.className = "absolute top-2 left-2 bg-primary text-[10px] px-2 py-1 rounded-full font-bold";
                badge.innerText = `#${index + 1} ${res.ratio}`;

                const dl = document.createElement('a');
                dl.href = res.url;
                dl.download = `generated-${index + 1}.png`;
                dl.className = "absolute top-2 right-2 bg-white/15 hover:bg-primary text-white p-2 rounded-full backdrop-blur border border-white/10 transition-colors";
                dl.innerHTML = `<span class="material-symbols-outlined text-sm">download</span>`;

                const upscale = document.createElement('button');
                upscale.className = "upscale-btn absolute bottom-2 left-2 text-[11px] font-bold px-3 py-1.5 rounded-full border border-white/10 bg-white/15 hover:bg-primary text-white transition-colors disabled:opacity-60 disabled:cursor-not-allowed";
                upscale.dataset.imageUrl = res.url;
                upscale.textContent = '4Kにする';
                upscale.onclick = (event) => { event.stopPropagation(); regenerate4k(res.url); };

                item.appendChild(img);
                item.appendChild(badge);
                item.appendChild(dl);
                item.appendChild(upscale);
                grid.appendChild(item);
                updateUpscaleButtonState(upscale);
            });

            const footer = document.createElement('div');
            footer.className = "px-4 py-3 bg-[#1a1421] flex items-center justify-between text-sm";
            footer.innerHTML = `<div class="flex flex-col"><span class="text-white font-bold">${modelName}</span><span class="text-[10px] text-[#ab9db9]">${results.length} images</span></div>`;

            card.appendChild(grid);
            card.appendChild(footer);
            content.appendChild(card);
        } else {
            const res = results[0];
            const card = document.createElement('div');
            card.className = "bg-surface-dark rounded-2xl border border-white/5 overflow-hidden shadow-xl";

            const imgWrapper = document.createElement('div');
            imgWrapper.className = "relative cursor-pointer overflow-hidden bg-black/50";
            imgWrapper.addEventListener('click', () => openModal(res.url, res.prompt));

            const img = document.createElement('img');
            img.src = res.url;
            img.className = "w-full h-auto max-h-[400px] object-contain";
            imgWrapper.appendChild(img);

            const footer = document.createElement('div');
            footer.className = "p-3 flex justify-between items-center bg-[#1a1421]";

            const footerText = document.createElement('div');
            footerText.className = "flex flex-col";
            const modelLabel = document.createElement('span');
            modelLabel.className = "text-xs font-bold text-white";
            modelLabel.textContent = modelName;
            const ratioLabel = document.createElement('span');
            ratioLabel.className = "text-[10px] text-[#ab9db9]";
            ratioLabel.textContent = res.ratio;
            footerText.appendChild(modelLabel);
            footerText.appendChild(ratioLabel);

            const actionWrap = document.createElement('div');
            actionWrap.className = "flex items-center gap-2";

            const upscaleBtn = document.createElement('button');
            upscaleBtn.className = "upscale-btn text-white text-[11px] font-bold px-3 py-1.5 rounded-full border border-white/10 bg-white/10 hover:bg-primary transition-colors disabled:opacity-60 disabled:cursor-not-allowed";
            upscaleBtn.dataset.imageUrl = res.url;
            upscaleBtn.textContent = '4Kにする';
            upscaleBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                regenerate4k(res.url);
            });

            const downloadLink = document.createElement('a');
            downloadLink.href = res.url;
            downloadLink.download = 'generated.png';
            downloadLink.className = "text-white hover:text-primary p-2 rounded-full hover:bg-white/10 transition-colors";
            downloadLink.innerHTML = '<span class="material-symbols-outlined text-sm">download</span>';

            actionWrap.appendChild(upscaleBtn);
            actionWrap.appendChild(downloadLink);

            footer.appendChild(footerText);
            footer.appendChild(actionWrap);

            card.appendChild(imgWrapper);
            card.appendChild(footer);
            content.appendChild(card);

            updateUpscaleButtonState(upscaleBtn);
        }

        const chatContainer = document.getElementById('chat-container');
        if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function updateUpscaleButtonState(button) {
        if (!button) return;
        const url = button.dataset.imageUrl;
        const apiKey = document.getElementById('settings-api-key-input').value.trim();
        const meta = imageMeta.get(url);
        const model = meta?.modelKey ? MODELS[meta.modelKey] : null;
        const isGemini = model?.type === 'gemini';
        const enabled = !!meta && isGemini && !!apiKey && button.dataset.loading !== '1';
        button.disabled = !enabled;
        button.textContent = button.dataset.loading === '1' ? '4K生成中...' : '4Kにする';
    }

    function setUpscaleLoading(imageUrl, isLoading) {
        document.querySelectorAll('.upscale-btn').forEach(btn => {
            if (btn.dataset.imageUrl === imageUrl) {
                btn.dataset.loading = isLoading ? '1' : '0';
                updateUpscaleButtonState(btn);
            }
        });
        const modalBtn = document.getElementById('modal-upscale-btn');
        const modalImage = document.getElementById('modal-image');
        if (modalBtn) {
            const modalTarget = modalBtn.dataset.imageUrl || modalImage?.src;
            if (modalTarget === imageUrl || (!isLoading && modalBtn.dataset.loading === '1')) {
                modalBtn.dataset.loading = isLoading ? '1' : '0';
                updateUpscaleButtonState(modalBtn);
            }
        }
    }

    async function imageToBase64(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error('元画像の取得に失敗しました');
        const blob = await response.blob();
        const buffer = await blob.arrayBuffer();
        const bytes = new Uint8Array(buffer);
        let binary = '';
        bytes.forEach(b => binary += String.fromCharCode(b));
        return { data: btoa(binary), mimeType: blob.type || 'image/png' };
    }

    async function regenerate4kFromModal() {
        const modalImage = document.getElementById('modal-image');
        if (modalImage?.src) {
            await regenerate4k(modalImage.src, true);
        }
    }

    async function regenerate4k(imageUrl, reopenModal = false) {
        const meta = imageMeta.get(imageUrl);
        const apiKey = document.getElementById('settings-api-key-input').value.trim();

        if (!meta || !meta.prompt) {
            showFeedback('この画像のプロンプト情報が見つかりません。', true);
            return;
        }

        if (!apiKey) {
            showFeedback('4K再生成にはAPIキーを入力してください。', true);
            return;
        }

        const model = meta.modelKey ? MODELS[meta.modelKey] : null;
        if (!model || model.type !== 'gemini') {
            showFeedback('4K再生成はGemini画像モデルで生成された画像のみ対応しています。', true);
            return;
        }

        setUpscaleLoading(imageUrl, true);

        const placeholderId = addGenerationPlaceholder('🤖 4K生成中...（待機中）');

        enqueueTask({
            type: 'upscale_4k',
            imageUrl,
            reopenModal,
            apiKey,
            modelKey: meta.modelKey,
            prompt: meta.prompt,
            ratio: meta.ratio,
            placeholderId,
        });
    }

    async function runUpscale4kTask(task) {
        const { imageUrl, reopenModal, apiKey, placeholderId } = task;
        const meta = imageMeta.get(imageUrl) || {};
        const prompt = task.prompt || meta.prompt;
        const modelKey = task.modelKey || meta.modelKey;
        const ratioBase = task.ratio || meta.ratio;
        const model = modelKey ? MODELS[modelKey] : null;

        if (!prompt) {
            throw new Error('この画像のプロンプト情報が見つかりません。');
        }

        if (!model || model.type !== 'gemini') {
            throw new Error('4K再生成はGemini画像モデルで生成された画像のみ対応しています。');
        }

        try {
            const ratio = sanitizeAspectRatio(ratioBase || await deriveAspectRatio(imageUrl) || '1:1');
            setImageMeta(imageUrl, { ratio });

            const inlineData = await imageToBase64(imageUrl);
            const inlineDataPart = { data: inlineData.data, mime_type: inlineData.mimeType };
            const requestBody = {
                contents: [{ parts: [
                    { text: prompt },
                    { inline_data: inlineDataPart }
                ] }],
                generationConfig: {
                    image_config: { aspect_ratio: ratio, image_size: '4K' }
                }
            };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model.id}:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`API Error ${response.status}: ${errText}`);
            }

            const data = await response.json();
            const imagePart = findInlineImage(data.candidates?.[0]?.content?.parts);
            if (!imagePart?.data || !imagePart.mimeType) {
                throw new Error('4K画像の取得に失敗しました');
            }

            const newUrl = `data:${imagePart.mimeType};base64,${imagePart.data}`;
            setImageMeta(newUrl, { prompt, ratio, modelKey, referenceImage: meta?.referenceImage || null });

            const displayRatio = `${ratio} / 4K`;
            if (placeholderId) {
                renderResultsInPlaceholder(placeholderId, [{ url: newUrl, prompt, ratio: displayRatio }], model.name);
            } else {
                addAIResult(newUrl, model.name, displayRatio);
            }

            const temperature = clampTemperature(document.getElementById('gen-temperature')?.value ?? 0.7);
            const referenceParsed = parseDataUrl(meta?.referenceImage || '');
            await saveGenerationHistory({
                prompt,
                aspectRatio: ratio,
                resolution: '4K',
                temperature,
                imageCount: 1,
                referenceImage: referenceParsed ? { data: referenceParsed.base64, mimeType: referenceParsed.mimeType } : null,
                images: [{ url: newUrl }],
            });
            showFeedback('4K画像を生成しました');

            if (reopenModal) {
                openModal(newUrl, prompt);
            }
        } catch (err) {
            if (placeholderId) {
                updatePlaceholderWithError(placeholderId, err?.message || '4K生成に失敗しました');
            }
            throw err;
        } finally {
            setUpscaleLoading(imageUrl, false);
        }
    }

    function addAIResult(url, modelName, ratio) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = "flex items-start gap-3 justify-start max-w-[80%] fade-in mb-6";
        div.innerHTML = `
            <div class="size-8 flex items-center justify-center bg-primary rounded-full shrink-0 mt-1">
                <span class="material-symbols-outlined text-white text-sm">auto_awesome</span>
            </div>
             <div class="bg-surface-dark rounded-2xl border border-white/5 overflow-hidden shadow-xl group">
                <div class="relative cursor-pointer overflow-hidden bg-black/50" onclick="openModal('${url}')">
                    <img src="${url}" class="w-full h-auto max-h-[400px] object-contain">
                </div>
                <div class="p-3 flex justify-between items-center bg-[#1a1421]">
                     <div class="flex flex-col">
                        <span class="text-xs font-bold text-white">${modelName}</span>
                        <span class="text-[10px] text-[#ab9db9]">${ratio}</span>
                     </div>
                     <div class="flex items-center gap-2">
                        <button class="upscale-btn text-white text-[11px] font-bold px-3 py-1.5 rounded-full border border-white/10 bg-white/10 hover:bg-primary transition-colors disabled:opacity-60 disabled:cursor-not-allowed" data-image-url="${url}" onclick="event.stopPropagation(); regenerate4k('${url}');">4Kにする</button>
                        <a href="${url}" download="generated.png" class="text-white hover:text-primary p-2 rounded-full hover:bg-white/10 transition-colors"><span class="material-symbols-outlined text-sm">download</span></a>
                     </div>
                </div>
            </div>
        `;
        container.appendChild(div);
        const upscaleBtn = div.querySelector('.upscale-btn');
        updateUpscaleButtonState(upscaleBtn);
        container.scrollTop = container.scrollHeight;
    }

    function addAIResultGroup(results, modelName) {
        const container = document.getElementById('chat-container');
        const wrapper = document.createElement('div');
        wrapper.className = "flex items-start gap-3 justify-start max-w-full fade-in mb-6";

        const icon = document.createElement('div');
        icon.className = "size-8 flex items-center justify-center bg-primary rounded-full shrink-0 mt-1";
        icon.innerHTML = `<span class="material-symbols-outlined text-white text-sm">auto_awesome</span>`;

        const card = document.createElement('div');
        card.className = "bg-surface-dark rounded-2xl border border-white/5 overflow-hidden shadow-xl flex-1";

        const grid = document.createElement('div');
        grid.className = "grid grid-cols-1 sm:grid-cols-2 gap-3 p-3 bg-black/30";

        results.forEach((res, index) => {
            const item = document.createElement('div');
            item.className = "relative cursor-pointer overflow-hidden bg-black/50 rounded-xl border border-border-dark";

            const img = document.createElement('img');
            img.src = res.url;
            img.className = "w-full h-auto max-h-[320px] object-contain";
            img.onclick = () => openModal(res.url);

            const badge = document.createElement('div');
            badge.className = "absolute top-2 left-2 bg-primary text-[10px] px-2 py-1 rounded-full font-bold";
            badge.innerText = `#${index + 1} ${res.ratio}`;

            const dl = document.createElement('a');
            dl.href = res.url;
            dl.download = `generated-${index + 1}.png`;
            dl.className = "absolute top-2 right-2 bg-white/15 hover:bg-primary text-white p-2 rounded-full backdrop-blur border border-white/10 transition-colors";
            dl.innerHTML = `<span class="material-symbols-outlined text-sm">download</span>`;

            const upscale = document.createElement('button');
            upscale.className = "upscale-btn absolute bottom-2 left-2 text-[11px] font-bold px-3 py-1.5 rounded-full border border-white/10 bg-white/15 hover:bg-primary text-white transition-colors disabled:opacity-60 disabled:cursor-not-allowed";
            upscale.dataset.imageUrl = res.url;
            upscale.textContent = '4Kにする';
            upscale.onclick = (event) => { event.stopPropagation(); regenerate4k(res.url); };

            item.appendChild(img);
            item.appendChild(badge);
            item.appendChild(dl);
            item.appendChild(upscale);
            grid.appendChild(item);
            updateUpscaleButtonState(upscale);
        });

        const footer = document.createElement('div');
        footer.className = "px-4 py-3 bg-[#1a1421] flex items-center justify-between text-sm";
        footer.innerHTML = `<div class="flex flex-col"><span class="text-white font-bold">${modelName}</span><span class="text-[10px] text-[#ab9db9]">${results.length} images</span></div>`;

        card.appendChild(grid);
        card.appendChild(footer);

        wrapper.appendChild(icon);
        wrapper.appendChild(card);

        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
    }

    function openModal(src, prompt = '', referenceImage = null) {
        const promptContainer = document.getElementById('modal-prompt-container');
        const promptElement = document.getElementById('modal-prompt');
        const referenceContainer = document.getElementById('modal-reference-container');
        const referenceImageElement = document.getElementById('modal-reference-image');
        document.getElementById('modal-image').src = src;
        document.getElementById('modal-download').href = src;
        const meta = imageMeta.get(src);
        const promptText = prompt || meta?.prompt || '';
        const referenceData = referenceImage || meta?.referenceImage || '';

        if (promptContainer && promptElement) {
            const hasPrompt = !!promptText;
            const hasReference = !!referenceData;
            if (hasPrompt || hasReference) {
                promptContainer.classList.remove('hidden');
            } else {
                promptContainer.classList.add('hidden');
            }
            promptElement.textContent = hasPrompt ? promptText : '';
        }

        if (referenceContainer && referenceImageElement) {
            if (referenceData) {
                referenceImageElement.src = referenceData;
                referenceContainer.classList.remove('hidden');
            } else {
                referenceImageElement.src = '';
                referenceContainer.classList.add('hidden');
            }
        }

        if (!meta?.ratio) {
            deriveAspectRatio(src).then(ratio => setImageMeta(src, { ratio }));
        }

        const upscaleBtn = document.getElementById('modal-upscale-btn');
        if (upscaleBtn) {
            upscaleBtn.dataset.imageUrl = src;
            updateUpscaleButtonState(upscaleBtn);
        }

        document.getElementById('image-modal').classList.remove('hidden');
    }
    function closeModal() {
        document.getElementById('image-modal').classList.add('hidden');
    }
</script>
</body>
</html>
